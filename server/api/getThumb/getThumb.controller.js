'use strict';



var config = require('../../config/environment');
var admin = require("firebase-admin");
var gcs = require('@google-cloud/storage')();

var Thumbler = require('thumbler');


/* 
 * get filename and token and generate a thumbnail for uploaded video
 * This api call generated by cloud function from Firebase
 */

exports.index = function(req, res) {

    var uid = (req.param('uid'))
    var filename = (req.param('timestamp'))
    var bucketName = 'dride-2384f.appspot.com';



    var filePath = 'clips/' + uid + '/' + filename + '.MP4'

    //download video file
    const bucket = gcs.bucket(bucketName);

    return bucket.file(filePath).download({
        destination: uid + '_' + filename + '.mp4'
    }, function(err) {
        if (err) {
            return err.message
        }


        //TODO: Resize the video width & height

        //take a snapshot
        Thumbler({
            type: 'video',
            input: uid + '_' + filename + '.mp4',
            output: uid + '_' + filename + '.jpg',
            time: '00:00:01',
            //size: '640x480' // this optional if null will use the destination of the video 
        }, function(err, path) {
            console.log(err)
            console.log(path)


            if (err) {
                console.log('--errr ' + err)
                return err;
            }


            return bucket.upload(uid + '_' + filename + '.jpg', {
		                destination: 'thumbs/' + uid + '/' + filename + '.jpg'
		            }).then(() => {
		            	console.log('upload !')
		                var db = admin.database();
		                var ref = db.ref("clips").child(uid).child(filename).update({

		                    thumbs: {
		                        'src': 'https://storage.cloud.google.com/dride-2384f.appspot.com/thumbs/' + uid + '/' + filename + '.jpg'
		                    },
		                    active: 1

		                })

		                console.log('Thumbnail uploaded to Storage at', path);
		                res.json({'status': 1});
		            });


            return path;
        });



    })

   



};
